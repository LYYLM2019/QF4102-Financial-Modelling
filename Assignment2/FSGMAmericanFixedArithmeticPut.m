function optValue = FSGMAmericanFixedArithmeticPut(t, T, S0, sigma, q, runningAvg, r, K, rho, N)  %% Meaning of the parameters of this function % t: time left to maturity measured in years % T: the total time to maturity from initiation % S0: the current underlier price % sigma: the underlier's volatility % q: the underlier's dividend yield % runningAvg: The current running average % r: the market's risk free rate % K: the fixed strike price for this option % rho: the FSGM parameter % N: the number of time periods in lattice  %% Initial set up of parameters  dt = t/N; m = 1/rho; % the reciprocal of paramter rho dx = sigma * sqrt(dt); dy = rho * dx; u = exp(dx); d = exp(-dx); p = (exp((r-q)*dt) - d) / (u-d);  elapsedTime = T - t; elapsedPeriods = elapsedTime / dt; currentPeriods = elapsedPeriods + 1; runningAvg = (runningAvg * elapsedPeriods + S0) / currentPeriods;  Average = zeros(2*N*m+1);  jshift = 1; kshift = N*m + 1;  for k = (-N*m):1:(N*m)    Average(k + kshift) = runningAvg * exp(k*dy); end  %% Initialization V = zeros(N+1, 2*N*m+1); for j = 0:1:N    for k = (-N*m):1:(N*m)        V(j+jshift, k+kshift) = (K - Average(k+kshift));    end end  %% Algorithm: looping for nl = (N-1):-1:0    for j = 0:1:nl        for k = (-nl*m):1:(nl*m)                    % Set ups for this round            S = S0 * exp((2 * j - nl) * dx);            n = nl + elapsedPeriods;            A = Average(k+kshift);                        Aup = (S * u + (n + 1) * A) / (n + 2);            kfloor = max(floor(log(Aup / S0) / dy), -N*m);            Vup_floor = V(j+1+jshift, kfloor+kshift);            Vup_floor_p1 = V(j+1+jshift, kfloor + 1+kshift);            Vup = LinearInterpolate(Aup, Average(kfloor+kshift), Average(kfloor + 1 +kshift), Vup_floor, Vup_floor_p1);                        Adown = (S * d + (n + 1) * A) / (n + 2);            kfloor = max(floor(log(Adown / S0) / dy), -N*m);            Vdown_floor = V(j+jshift, kfloor+kshift);            Vdown_floor_p1 = V(j+jshift, kfloor + 1+kshift);            Vdown = LinearInterpolate(Adown, Average(kfloor+kshift), Average(kfloor + 1+kshift), Vdown_floor, Vdown_floor_p1);                        V(j+jshift) = max(exp(-r * dt) * (p * Vup + (1 - p) * Vdown), (K-A));                                end    end end  optValue = max(V(0+jshift, 0+kshift), (K-runningAvg)); endfunction sol = LinearInterpolate(x, x0, x1, f0, f1)  sol = (x - x1) / (x0 - x1) * f0 + (x - x0) / (x1 - x0) * f1;end